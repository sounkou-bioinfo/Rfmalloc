---
output: github_document
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# Rfmalloc

Rfmalloc provides persistent memory allocation capabilities for R using the fmalloc library. It offers file-backed memory allocation with full malloc, free, and realloc support for efficient persistent storage.

## Key Features

- **File-backed allocation** - Memory allocated from memory-mapped files
- **Full realloc support** - Supports malloc, free, and realloc patterns  
- **Persistent storage** - Data persists across R sessions
- **Efficient memory management** - Based on ptmalloc3 algorithm

## Installation

```{r eval=FALSE}
# install.packages("devtools")
devtools::install_github("sounkou-bioinfo/Rfmalloc")
```

## Basic Usage

```{r eval=TRUE}
library(Rfmalloc)

# Initialize fmalloc with a backing file
alloc_file <- tempfile(fileext = ".bin")
init_fmalloc(alloc_file)

# Create vectors using file-backed allocation
v_int <- create_fmalloc_vector("integer", 10)
v_num <- create_fmalloc_vector("numeric", 10)

# Use the vectors normally
v_int[1:3] <- c(1L, 2L, 3L)
v_num[1:3] <- c(1.1, 2.2, 3.3)

print(v_int[1:3])
print(v_num[1:3])

# Clean up - force garbage collection before cleanup to avoid warnings  
rm(v_int, v_num)
gc()
cleanup_fmalloc()
file.remove(alloc_file)
```

## Larger Examples

```{r eval=TRUE}
library(Rfmalloc)

# Create a 100MB backing file
large_file <- tempfile(fileext = ".bin")
init_fmalloc(large_file, size_gb = 0.1)

# Create larger vectors
vec1 <- create_fmalloc_vector("integer", 1000)
vec2 <- create_fmalloc_vector("numeric", 500)

# Fill with data
vec1[1:10] <- 1:10
vec2[1:10] <- (1:10) * 1.5

cat("Sample data:", vec1[1:5], "\n")
cat("Random access:", vec1[sample(10, 3)], "\n")

# Clean up - force garbage collection before cleanup to avoid warnings
rm(vec1, vec2)
gc()
cleanup_fmalloc()
file.remove(large_file)
```
## References

Please note that this project uses the fmalloc library from [https://github.com/yasukata/fmalloc](https://github.com/yasukata/fmalloc) and custom allocator concepts from [https://gist.github.com/s-u/6712c97ca74181f5a1a5](https://gist.github.com/s-u/6712c97ca74181f5a1a5).

## License

This project is licensed under GPL (>= 2).
